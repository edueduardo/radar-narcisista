================================================================================
RADAR NARCISISTA - AUDITORIA COMPLETA DE PROMPTS E PATCHES
================================================================================
Gerado em: 02/12/2025
Fonte: Chat completo entre Eduardo e ChatGPT/Windsurf
Objetivo: Consolidar TODOS os prompts e patches para auditoria no Windsurf
================================================================================

================================================================================
PROMPT 1: ETAPA 7.2 ‚Äì PLANO DE INTEGRA√á√ÉO (SEM CODAR)
================================================================================

Entendido. Vou definir em texto a arquitetura e os fluxos para a integra√ß√£o do Plano de Seguran√ßa com o Tri√¢ngulo.

---

## 1. DISPARO AUTOM√ÅTICO (Clareza ‚Üí Plano de Seguran√ßa)

### Regra de Neg√≥cio
- Se no teste de clareza `hasPhysicalRisk = true` (calculado quando categoria `fisico` >= 30%), o sistema deve:
  1. Salvar flag `has_physical_risk = true` no teste (`clarity_tests`)
  2. Mostrar banner de alerta no Dashboard recomendando revisar/criar Plano de Seguran√ßa
  3. Criar registro em `risk_alerts` com:
     - `source = 'clarity_test'` 
     - `source_id = test_id` 
     - `level = 'HIGH'` ou `'CRITICAL'` (se >= 50%)
     - `category = 'PHYSICAL_VIOLENCE'` 
     - `recommendation = 'Revise seu Plano de Seguran√ßa'` 

### Arquivos a Modificar
| Arquivo | Mudan√ßa |
|---------|---------|
| app/api/clarity/activate-profile/route.ts | Adicionar cria√ß√£o de `risk_alert` quando `hasPhysicalRisk` |
| app/dashboard/page.tsx | Adicionar banner de alerta + card "Plano de Seguran√ßa" |

---

## 2. DETEC√á√ÉO VIA DI√ÅRIO (Di√°rio ‚Üí Plano de Seguran√ßa)

### Regra de Neg√≥cio
- Tags de viol√™ncia no di√°rio: `ameaca_velada`, `explosao`, `agressao_verbal`, `ameacas` 
- Ap√≥s N epis√≥dios graves em 30 dias (sugest√£o: N = 3), sugerir revis√£o do plano
- Implementa√ß√£o: verificar no Dashboard ao carregar dados

### Arquivos a Modificar
| Arquivo | Mudan√ßa |
|---------|---------|
| app/dashboard/page.tsx | Adicionar l√≥gica de contagem de tags graves nos √∫ltimos 30 dias |

### PENDENTE-V2
- Cria√ß√£o autom√°tica de `risk_alert` quando tags graves s√£o usadas (requer processamento no backend)

---

## 3. DETEC√á√ÉO VIA CHAT (Chat ‚Üí Plano de Seguran√ßa)

### Regra de Neg√≥cio (IMPLEMENTAR AGORA)
- Regex simples para detectar termos de perigo f√≠sico:
  ```regex
  /\b(me\s+bateu|me\s+agrediu|me\s+machucou|amea√ß(ou|a|ando)|vai\s+me\s+matar|medo\s+de\s+morrer|viol√™ncia|apanho|apanhei|socou|empurrou|estrangul)/i
  ```
- Quando detectado:
  1. Mostrar banner no chat: "üö® Percebemos um poss√≠vel risco. Considere revisar seu Plano de Seguran√ßa."
  2. Criar registro em `risk_alerts` com:
     - `source = 'chat'` 
     - `source_id = message_id` (se dispon√≠vel)
     - `level = 'HIGH'` 
     - `category = 'PHYSICAL_VIOLENCE'` ou `'THREATS'` 

### Arquivos a Modificar
| Arquivo | Mudan√ßa |
|---------|---------|
| `app/chat/page.tsx` | Adicionar regex de detec√ß√£o + banner de sugest√£o |
| `app/api/chat/route.ts` | Adicionar cria√ß√£o de `risk_alert` quando detectado |

### PENDENTE-V2
- Detec√ß√£o via IA (an√°lise sem√¢ntica mais sofisticada)

---

## 4. PERSIST√äNCIA (Plano ‚Üí Di√°rio)

### Regra de Neg√≥cio
- Ao criar ou atualizar plano de seguran√ßa, registrar entrada no di√°rio com:
  - `entry_type = 'safety_plan'` 
  - `title = 'Plano de Seguran√ßa atualizado'` 
  - `description = 'Voc√™ atualizou seu Plano de Seguran√ßa em [data]'` 
  - `tags = ['seguranca', 'plano']` 

### Arquivos a Modificar
| Arquivo | Mudan√ßa |
|---------|---------|
| types/database.ts | Adicionar `'safety_plan'` ao tipo JournalEntryType |
| `app/api/safety-plan/route.ts` | **CRIAR** ‚Äì API REST com GET/POST/PATCH + cria√ß√£o de entrada no di√°rio |
| app/plano-seguranca/page.tsx | Usar nova API em vez de chamadas diretas ao Supabase |

---

## 5. UI / DASHBOARD

### Card "Plano de Seguran√ßa"
| Campo | Valor |
|-------|-------|
| T√≠tulo | "Plano de Seguran√ßa" |
| √çcone | Shield (lucide) |
| Status | `NOT_STARTED` ‚Üí "N√£o iniciado" (vermelho) |
|        | `IN_PROGRESS` ‚Üí "Em progresso" (amarelo) |
|        | `READY` ‚Üí "Pronto" (verde) |
| A√ß√£o | Link para `/plano-seguranca` |

### Banner de Alerta (hasPhysicalRisk)
| Condi√ß√£o | Exibi√ß√£o |
|----------|----------|
| `hasPhysicalRisk = true` E `!hasSafetyPlan` | Banner vermelho: "‚ö†Ô∏è Risco f√≠sico detectado. Crie seu Plano de Seguran√ßa agora." |
| `hasPhysicalRisk = true` E `hasSafetyPlan` E `status != 'READY'` | Banner amarelo: "‚ö†Ô∏è Risco f√≠sico detectado. Revise seu Plano de Seguran√ßa." |
| `hasPhysicalRisk = true` E `status = 'READY'` | Banner verde: "‚úÖ Seu Plano de Seguran√ßa est√° pronto. Mantenha-o atualizado." |

### Arquivos a Modificar
| Arquivo | Mudan√ßa |
|---------|---------|
| app/dashboard/page.tsx | Adicionar card + banner + l√≥gica de status |

---

## 6. API `/api/safety-plan` 

### Endpoints
| M√©todo | Descri√ß√£o |
|--------|-----------|
| GET | Retorna plano do usu√°rio autenticado |
| POST | Cria novo plano (se n√£o existir) |
| `PATCH` | Atualiza plano existente |

### Valida√ß√£o de Schema
```typescript
interface SafetyPlanPayload {
  emergency_contacts?: Array<{
    name: string
    phone: string
    relationship: string
    is_primary?: boolean
  }>
  important_documents?: Array<{
    name: string
    location: string
    has_copy: boolean
  }>
  emergency_bag_items?: Array<{
    item: string
    packed: boolean
  }>
  safe_place?: {
    address: string
    contact_name: string
    contact_phone: string
    notes: string
  }
  digital_security?: {
    changed_passwords: boolean
    removed_tracking_apps: boolean
    uses_private_browsing: boolean
    has_secure_email: boolean
  }
  notes?: string
}
```

### Efeito Colateral
- Ap√≥s POST/PATCH bem-sucedido, criar entrada no di√°rio (`entry_type = 'safety_plan'`)

### Arquivo a Criar
| Arquivo | Descri√ß√£o |
|---------|-----------|
| `app/api/safety-plan/route.ts` | API REST completa |

---

## 7. BADGES NO DI√ÅRIO

### Arquivos a Modificar
| Arquivo | Mudan√ßa |
|---------|---------|
| `app/diario/page.tsx` | Adicionar badge "Plano de Seguran√ßa" (üõ°Ô∏è) para `entry_type = 'safety_plan'` |
| `app/diario/timeline/page.tsx` | Adicionar badge "Plano de Seguran√ßa" (üõ°Ô∏è) para `entry_type = 'safety_plan'` |

---

## 8. RESUMO DO QUE SER√Å IMPLEMENTADO NA ETAPA 7.3

| Item | Prioridade | Complexidade |
|------|------------|--------------|
| 1. Adicionar `'safety_plan'` ao JournalEntryType | ALTA | Baixa |
| 2. Criar API `/api/safety-plan` (GET/POST/PATCH) | ALTA | M√©dia |
| 3. Card "Plano de Seguran√ßa" no Dashboard | ALTA | Baixa |
| 4. Banner de alerta `hasPhysicalRisk` no Dashboard | ALTA | Baixa |
| 5. Entrada autom√°tica no di√°rio ao salvar plano | ALTA | M√©dia |
| 6. Badge "Plano de Seguran√ßa" no /diario e /diario/timeline | ALTA | Baixa |
| 7. Detec√ß√£o regex no chat + banner de sugest√£o | M√âDIA | M√©dia |
| 8. Cria√ß√£o de `risk_alert` no chat quando detectado | M√âDIA | M√©dia |
| 9. Cria√ß√£o de `risk_alert` no activate-profile quando `hasPhysicalRisk` | M√âDIA | Baixa |
| 10. Atualizar documenta√ß√£o (ATLAS, ROADMAP, TESTES, TUDO PARA O GPT) | ALTA | M√©dia |

---

## 9. O QUE FICAR√Å COMO PENDENTE-V2

| Item | Motivo |
|------|--------|
| Detec√ß√£o de risco via IA no chat (an√°lise sem√¢ntica) | Complexidade alta, requer fine-tuning |
| Cria√ß√£o autom√°tica de `risk_alert` ao salvar epis√≥dio com tags graves | Requer processamento no backend |
| Notifica√ß√µes push/email quando `risk_alert` √© criado | Infraestrutura de notifica√ß√µes n√£o existe |
| Centro de alertas no Dashboard (listar todos os `risk_alerts`) | Escopo maior, pode ser pr√≥xima etapa |

---

## [CHECKLIST FINAL]

1. Definir regra de disparo autom√°tico (Clareza ‚Üí Plano) ‚Üí **[OK]**
2. Definir detec√ß√£o via Di√°rio ‚Üí **[OK]**
3. Definir detec√ß√£o via Chat (regex) ‚Üí **[OK]**
4. Definir persist√™ncia (Plano ‚Üí Di√°rio) ‚Üí **[OK]**
5. Definir UI/Dashboard (card + banner) ‚Üí **[OK]**
6. Definir API `/api/safety-plan` ‚Üí **[OK]**
7. Definir badges no Di√°rio ‚Üí **[OK]**
8. Listar o que ser√° implementado na ETAPA 7.3 ‚Üí **[OK]**
9. Listar o que ficar√° como PENDENTE-V2 ‚Üí **[OK]**

================================================================================
PROMPT 2: ETAPA 7.3 ‚Äì IMPLEMENTA√á√ÉO (CODAR)
================================================================================

NOME DO PROMPT: RADAR ‚Äì ETAPA 7.3 ‚Äì INTEGRA√á√ÉO PLANO DE SEGURAN√áA

Voc√™ √© um(a) dev s√™nior em Next.js + TypeScript + Tailwind + Supabase.  
Projeto: "radar-narcisista" (MVP j√° rodando).

REGRAS GERAIS (N√ÉO IGNORAR):
1. Voc√™ N√ÉO PODE dizer que implementou algo se n√£o mexeu no c√≥digo.
2. Sempre mostre quais arquivos foram alterados e o que ainda falta.
3. Se um arquivo/tabela n√£o existir, voc√™ deve DIZER ISSO claramente e ent√£o propor/criar a melhor alternativa.
4. N√£o instalar novas libs sem autoriza√ß√£o expl√≠cita.
5. N√£o quebrar o build. Se quebrar, conserte antes de dizer que a etapa foi conclu√≠da.

MISS√ÉO DA ETAPA 7.3:
Implementar a integra√ß√£o do **Plano de Seguran√ßa** com o **Tri√¢ngulo de Risco**, seguindo o plano da ETAPA 7.2:

- Disparo autom√°tico via Teste de Clareza
- Detec√ß√£o via Chat (regex)
- Persist√™ncia do plano e registro no Di√°rio
- Card + banners no Dashboard
- Badges no Di√°rio
- Cria√ß√£o e uso da API `/api/safety-plan` 

ORDEM DE IMPLEMENTA√á√ÉO (SIGA ESTA ORDEM):

ETAPA 1 ‚Äì TIPOS E SCHEMA
1. Abrir `types/database.ts` e localizar o tipo `JournalEntryType`.
2. Adicionar o valor `'safety_plan'` ao `JournalEntryType`.
3. Verificar no schema (migrations ou `schema.sql`):
   - Se j√° existem:
     - `clarity_tests` (com coluna `has_physical_risk` ou similar).
     - `risk_alerts`.
     - `journal_entries` (campo `entry_type`).
     - Alguma tabela de plano de seguran√ßa (`safety_plans` ou similar).
4. Se algum desses itens n√£o existir, me informe no coment√°rio do commit/explica√ß√£o e crie a tabela m√≠nima compat√≠vel com o uso descrito:
   - `risk_alerts`: campos m√≠nimos ‚Üí `id`, `user_id`, `source`, `source_id`, `level`, `category`, `recommendation`, `created_at`.
   - `clarity_tests`: se necess√°rio, acrescentar `has_physical_risk boolean default false`.

ETAPA 2 ‚Äì API `/api/safety-plan` 
1. Criar `app/api/safety-plan/route.ts`.
2. Implementar os m√©todos:
   - `GET`: retorna o plano de seguran√ßa do usu√°rio autenticado.
   - `POST`: cria novo plano se n√£o existir.
   - `PATCH`: atualiza o plano existente.
3. Usar um payload alinhado com:

   interface SafetyPlanPayload {
     emergency_contacts?: Array<{
       name: string
       phone: string
       relationship: string
       is_primary?: boolean
     }>
     important_documents?: Array<{
       name: string
       location: string
       has_copy: boolean
     }>
     emergency_bag_items?: Array<{
       item: string
       packed: boolean
     }>
     safe_place?: {
       address: string
       contact_name: string
       contact_phone: string
       notes: string
     }
     digital_security?: {
       changed_passwords: boolean
       removed_tracking_apps: boolean
       uses_private_browsing: boolean
       has_secure_email: boolean
     }
     notes?: string
   }

4. Ap√≥s `POST` ou `PATCH` bem-sucedido, registrar entrada em `journal_entries`:
   - `entry_type = 'safety_plan'` 
   - `title = 'Plano de Seguran√ßa atualizado'` 
   - `description` com data/hora
   - `tags = ['seguranca', 'plano']` 

ETAPA 3 ‚Äì P√ÅGINA `/plano-seguranca` 
1. Abrir `app/plano-seguranca/page.tsx`.
2. Substituir qualquer acesso direto ao Supabase pela API `/api/safety-plan`.
3. Definir um status interno do plano:
   - `NOT_STARTED`: nenhum plano encontrado.
   - `IN_PROGRESS`: plano encontrado, mas campos essenciais faltando.
   - `READY`: plano com contatos de emerg√™ncia + local seguro + bolsa de emerg√™ncia b√°sica preenchidos.
4. Exportar esse status de forma que o Dashboard consiga usar (via fetch ou hook compartilhado, conforme padr√£o atual do projeto).

ETAPA 4 ‚Äì DISPARO AUTOM√ÅTICO VIA TESTE DE CLAREZA
1. Abrir `app/api/clarity/activate-profile/route.ts`.
2. Garantir que, quando `hasPhysicalRisk = true`:
   - `has_physical_risk` √© salvo na tabela `clarity_tests`.
   - √â criado um registro em `risk_alerts` com:
     - `source = 'clarity_test'` 
     - `source_id = test_id` 
     - `level = 'HIGH'` ou `'CRITICAL'` (se o score f√≠sico >= 50%).
     - `category = 'PHYSICAL_VIOLENCE'` 
     - `recommendation = 'Revise seu Plano de Seguran√ßa'`.

ETAPA 5 ‚Äì DASHBOARD (CARD + BANNERS)
1. Abrir `app/dashboard/page.tsx`.
2. Adicionar o **card "Plano de Seguran√ßa"** com √≠cone `Shield` (lucide-react), status colorido:
   - `NOT_STARTED` ‚Üí vermelho / "N√£o iniciado".
   - `IN_PROGRESS` ‚Üí amarelo / "Em progresso".
   - `READY` ‚Üí verde / "Pronto".
   - Clique leva para `/plano-seguranca`.
3. Adicionar banners de alerta usando:
   - Flag `has_physical_risk` do teste de clareza.
   - Status do plano de seguran√ßa.
4. Regras de banner:
   - `hasPhysicalRisk = true` e `!hasSafetyPlan`:
     ‚Üí banner vermelho: "‚ö†Ô∏è Risco f√≠sico detectado. Crie seu Plano de Seguran√ßa agora."
   - `hasPhysicalRisk = true` e `hasSafetyPlan` e status != `READY`:
     ‚Üí banner amarelo: "‚ö†Ô∏è Risco f√≠sico detectado. Revise seu Plano de Seguran√ßa."
   - `hasPhysicalRisk = true` e status = `READY`:
     ‚Üí banner verde: "‚úÖ Seu Plano de Seguran√ßa est√° pronto. Mantenha-o atualizado."

ETAPA 6 ‚Äì DETEC√á√ÉO DE RISCO NO CHAT (REGEX)
1. Abrir `app/chat/page.tsx`.
2. Adicionar a seguinte regex para mensagens de risco f√≠sico:

   /\b(me\s+bateu|me\s+agrediu|me\s+machucou|amea√ß(ou|a|ando)|vai\s+me\s+matar|medo\s+de\s+morrer|viol√™ncia|apanho|apanhei|socou|empurrou|estrangul)/i

3. Quando a mensagem do usu√°rio bater nessa regex:
   - Mostrar banner no chat:
     "üö® Percebemos um poss√≠vel risco. Considere revisar seu Plano de Seguran√ßa."
4. Abrir `app/api/chat/route.ts`:
   - Validar a mensagem com a mesma regex.
   - Se bater:
     - Criar `risk_alert` com:
       - `source = 'chat'` 
       - `source_id = message_id` (se dispon√≠vel)
       - `level = 'HIGH'` 
       - `category = 'PHYSICAL_VIOLENCE'` ou `'THREATS'`.

ETAPA 7 ‚Äì DI√ÅRIO E BADGES
1. Abrir `app/diario/page.tsx`:
   - Para entradas com `entry_type === 'safety_plan'`, exibir badge üõ°Ô∏è "Plano de Seguran√ßa".
2. Abrir `app/diario/timeline/page.tsx`:
   - Aplicar a mesma regra de badge na visualiza√ß√£o de timeline.

ETAPA 8 ‚Äì TESTES MANUAIS M√çNIMOS
Criar e executar cen√°rios de teste (pode ser descrito em coment√°rio ou arquivo de testes j√° existente):

1. Teste de clareza com risco f√≠sico:
   - Gerar teste onde `fisico >= 30%`.
   - Verificar:
     - `has_physical_risk = true` no banco.
     - `risk_alert` criado com `source = 'clarity_test'`.
     - Banner correto no Dashboard.
2. Plano de seguran√ßa:
   - Abrir `/plano-seguranca`, criar plano.
   - Verificar:
     - Entrada no di√°rio com `entry_type = 'safety_plan'`.
     - Status do card no Dashboard muda conforme preenchimento.
3. Chat:
   - Enviar mensagem com texto: "ele me bateu e amea√ßou me matar".
   - Verificar:
     - Banner dentro do chat.
     - `risk_alert` criado com `source = 'chat'`.
4. Di√°rio:
   - Verificar que entradas `safety_plan` mostram badge üõ°Ô∏è nas p√°ginas `/diario` e `/diario/timeline`.

NO FIM:
1. Me mostrar um resumo:
   - Arquivos alterados.
   - Tabelas criadas/alteradas.
   - O que foi completamente implementado.
   - Qualquer item da ETAPA 7.3 que N√ÉO foi poss√≠vel implementar (com motivo claro).
2. Gerar um pequeno texto de LOG para eu colar em `TUDO PARA O GPT.txt` descrevendo a conclus√£o da ETAPA 7.3.

N√ÉO pule nenhuma etapa. Se n√£o conseguir fazer alguma, explique o motivo com clareza.

================================================================================
PROMPT 3: MAPEAMENTO COMPLETO DO PROJETO (AUDITORIA GERAL)
================================================================================

Quero que voc√™ leia e mapeie o projeto RADAR NARCISISTA COMPLETO.

Reposit√≥rio: https://github.com/edueduardo/radar-narcisista

IMPORTANTE: 
‚Äì Voc√™ N√ÉO TEM PERMISS√ÉO de pular etapas.
‚Äì Voc√™ N√ÉO TEM PERMISS√ÉO de dizer que fez algo que n√£o fez.
‚Äì Se n√£o conseguir ler algum arquivo ou pasta, voc√™ deve me avisar exatamente o que n√£o conseguiu acessar.

================================
ETAPA 1 ‚Äì LEITURA GERAL DO REPO
================================
1. Navegue pelo reposit√≥rio e liste:
   ‚Äì Principais arquivos de documenta√ß√£o (ex.: README, PROJETO_COMPLETO_..., TUDO_PARA_O_GPT.txt, etc.).
   ‚Äì Principais pastas de c√≥digo (ex.: app/, src/, components/, lib/, api/, supabase/, migrations/, etc.).
2. Me devolva UMA LISTA OBJETIVA com:
   ‚Äì Quais docs voc√™ encontrou e leu.
   ‚Äì Quais pastas de c√≥digo existem e para que servem (palpite t√©cnico, mas SEM inventar coisas sem base).

Se nesta etapa houver algo que n√£o conseguiu ler, voc√™ √© obrigado a dizer.

=====================================
ETAPA 2 ‚Äì MAPA DA ARQUITETURA DO SAAS
=====================================
Aqui voc√™ vai montar o "RAIO-X" do Radar Narcisista.

1. Descrever a STACK:
   ‚Äì Framework (Next.js, vers√£o, TypeScript, etc.).
   ‚Äì Banco / backend (Supabase, APIs internas, etc.).
   ‚Äì UI principal (Tailwind, componentes, etc.).
   ‚Äì Integra√ß√µes (OpenAI/Anthropic/etc. se existirem no c√≥digo).

2. Mapear os M√ìDULOS:
   ‚Äì P√°ginas principais (ex.: landing, login, dashboard, di√°rio, check-ins, LGPD, blog, admin, mapa de IAs, etc.).
   ‚Äì Rotas API relevantes (ex.: /api/..., webhooks, rotas de IA, etc.).
   ‚Äì Painel de admin (se existir): o que d√° pra configurar l√°.

3. Mapear o BANCO:
   ‚Äì Listar as tabelas principais (nome + fun√ß√£o).
   ‚Äì Descrever campos importantes e rela√ß√µes (sem entrar em n√≠vel absurdo de detalhe, mas o suficiente para entender o modelo mental).
   ‚Äì Apontar qualquer coisa relacionada a logs, hash, cadeia de cust√≥dia, evid√™ncia, etc., se existirem.

Voc√™ deve entregar um texto organizado (por t√≥picos) com:
‚Äì Stack
‚Äì M√≥dulos
‚Äì Banco

==============================================
ETAPA 3 ‚Äì O QUE EXISTE, O QUE FALTA, O QUE EST√Å MEIO TERMO
==============================================
Agora voc√™ vai ser cr√≠tico:

1. A partir da leitura do c√≥digo + docs, classificar:
   ‚Äì FUNCIONANDO/IMPLEMENTADO: coisas que claramente existem no c√≥digo e parecem us√°veis.
   ‚Äì RASCUNHO/PARCIAL: coisas come√ßadas, mas incompletas.
   ‚Äì IDEA√á√ÉO/PLANEJADO: coisas escritas em documentos, mas sem c√≥digo (ou muito pouco).

2. Fa√ßa uma LISTA DE PEND√äNCIAS priorizada:
   ‚Äì Bugs ou inconsist√™ncias prov√°veis.
   ‚Äì Telas feias/confusas que precisam de refactor (ex.: frontpage sem "cara de 1 milh√£o de d√≥lares").
   ‚Äì Pontos de LGPD, seguran√ßa, hash, evid√™ncia etc. que parecem fr√°geis ou faltando.

N√£o invente: se for suposi√ß√£o, escreva como suposi√ß√£o.

====================================
ETAPA 4 ‚Äì CRIAR O "RESUMO BASE OFICIAL"
====================================
Com tudo acima, agora voc√™ vai gerar um documento √∫nico chamado:

RADAR_NARCISISTA_RESUMO_BASE_v1

Ele deve conter, em se√ß√µes:

1. VIS√ÉO GERAL
   ‚Äì 1‚Äì2 par√°grafos explicando o que √© o Radar Narcisista, para que serve, para quem √©.

2. STACK T√âCNICA
   ‚Äì Framework, banco, integra√ß√µes, estrutura geral.

3. M√ìDULOS DO SISTEMA
   ‚Äì Lista dos m√≥dulos (ex.: Onboarding, Di√°rio/Desabafos, Check-ins, IA Coach, LGPD, Admin, Blog, etc.).
   ‚Äì Para cada m√≥dulo: o que faz, quais telas tem (em alto n√≠vel) e se est√° IMPLEMENTADO, PARCIAL ou S√ì EM IDEIA.

4. BANCO DE DADOS / SUPABASE
   ‚Äì Tabelas principais (nome + uma frase de fun√ß√£o).
   ‚Äì Rela√ß√µes importantes (usu√°rio ‚Üí di√°rios, usu√°rio ‚Üí check-ins, etc.).
   ‚Äì Qualquer coisa ligada a logs, cadeia de cust√≥dia, auditoria de provas (se existir).

5. LISTA DE PR√ìXIMOS PASSOS
   ‚Äì Pr√≥ximos passos para:
     a) Arrumar o que est√° quebrado/feio.
     b) Fechar o MVP para uso real.
     c) Melhorar seguran√ßa, LGPD, evid√™ncia, hash etc., se j√° aparecer no projeto.

O RESUMO BASE deve ser escrito de forma que eu possa:
‚Äì Copiar e colar em um arquivo .txt no meu computador;
‚Äì Reusar em futuras conversas com outras IAs como "contexto oficial do projeto".

====================================
REGRAS DE COMPORTAMENTO
====================================
‚Äì N√£o diga nunca "j√° li tudo e est√° perfeito" se voc√™ n√£o tiver certeza.
‚Äì Se o limite de contexto n√£o permitir ler tudo, seja honesto: diga o que foi lido e o que ficou de fora.
‚Äì Em TODAS as respostas futuras sobre este projeto, use o RADAR_NARCISISTA_RESUMO_BASE_v1 como refer√™ncia mental.
‚Äì Sempre que eu pedir uma nova funcionalidade, voc√™ deve:
   1. Ver se conflita com a arquitetura atual.
   2. Me avisar se estiver quebrando alguma l√≥gica j√° descrita.
   3. Sugerir o caminho mais limpo dentro do que j√° existe.

Seu primeiro output agora deve ser:
1) Confirma√ß√£o de que come√ßou a Etapa 1.
2) Assim que terminar a Etapa 1, me mostrar a lista de arquivos/pastas que identificou antes de seguir para a Etapa 2.

================================================================================
PROMPT 4: MEGA PROMPT DE AUDITORIA GERAL (WINDSURF)
================================================================================

RADAR NARCISISTA ‚Äì MEGA PROMPT DE AUDITORIA GERAL
=================================================
(Para colar no Windsurf como UM √öNICO PROMPT)

IDENTIDADE
----------
Voc√™ √© um dev s√™nior usando Windsurf para trabalhar no projeto RADAR NARCISISTA.

Stack principal:
- Next.js 16 + TypeScript
- TailwindCSS
- Supabase (Postgres + Auth + RLS + Migrations)
- Stripe (billing)
- Deploy na Vercel

Reposit√≥rio (j√° configurado no Windsurf):
- Cont√©m arquivos como:
  - TUDO PARA O GPT.txt
  - ATLAS-RADAR-NARCISISTA.txt
  - ROADMAP-RADAR.txt
  - LAMPADA-RADAR.txt
  - TESTES-RADAR.txt
  - docs/PATCH-ORACULO.md
  - docs/REGRAS-COMUNICACAO-IA.md
  - CHECKLIST-POS-MVP.md
  - c√≥digo em app/, lib/, docs/, database/, etc.

REGRAS GERAIS
-------------
1) Voc√™ N√ÉO tem permiss√£o para mentir.
2) N√£o marque nada como "feito" se n√£o conseguiu implementar.
3) Se algo ficar metade feito, registre claramente como "parcial / incompleto".
4) Nunca use a palavra "opcional" ou varia√ß√µes. Use sempre "MELHORIAS IDENTIFICADAS".
5) N√£o use "ou" dentro de uma mesma bullet. Divida caminhos em bullets separados.
6) Sempre que mexer em c√≥digo, rode build e registre erros se houver.
7) Sempre que terminar um bloco de tarefas, atualize TUDO PARA O GPT.txt, ATLAS, ROADMAP, TESTES e L√ÇMPADA.

OBJETIVO DESTE PROMPT
---------------------
Fazer uma AUDITORIA GERAL de TODOS os requisitos j√° documentados no reposit√≥rio, especialmente:

- TUDO PARA O GPT.txt  (fonte principal de prompts e requisitos)
- PATCH-ORACULO.md     (corre√ß√£o conceitual Or√°culo V1/V2 + bloco 26‚Äì30)
- REGRAS-COMUNICACAO-IA.md
- BLOCO 21‚Äì25 (j√° descrito em TUDO PARA O GPT.txt)
- CHECKLIST-POS-MVP.md

E tamb√©m implementar os REQUISITOS NOVOS que podem n√£o ter sido salvos em TUDO PARA O GPT.txt, em especial:
- MATRIZ GLOBAL DE IAs por menu, plano, promo√ß√£o e cliente.
- Painel de controle de IA por menu (admin).
- Modo SIMULA√á√ÉO / IMPERSONATION (usu√°ria, profissional, whitelabel, gerador).
- Help/Manual embutido por menu (admin, whitelabel, gerador, profissional, usu√°ria).
- Organiza√ß√£o do menu administrativo por prioridade.
- Sincroniza√ß√£o com GERADOR DE SAAS (core compartilhado de regras).

ORDEM DAS ETAPAS DESTE PROMPT
-----------------------------
Voc√™ deve seguir ESTA ORDEM e registrar tudo no final.

ETAPA A ‚Äì LEITURA COMPLETA DOS DOCS
-----------------------------------
1. Abrir e ler com aten√ß√£o:
   - TUDO PARA O GPT.txt
   - ATLAS-RADAR-NARCISISTA.txt
   - ROADMAP-RADAR.txt
   - LAMPADA-RADAR.txt
   - TESTES-RADAR.txt
   - docs/PATCH-ORACULO.md
   - docs/REGRAS-COMUNICACAO-IA.md
   - CHECKLIST-POS-MVP.md

2. A partir desses arquivos, montar internamente uma lista de REQUISITOS:
   - Prompts de implementa√ß√£o (BLOCO 1‚Äì20, BLOCO 21‚Äì25, etc.).
   - Patches (PATCH OR√ÅCULO, LGPD, etc.).
   - Itens de roadmap "AGORA" vs "FUTURO".
   - Ideias na L√ÇMPADA que j√° foram promovidas para implementa√ß√£o.

3. N√ÉO reescreva tudo aqui no chat. Apenas crie essa lista na mem√≥ria do agente e cite os itens por ID/t√≠tulo quando for se referir a eles.

ETAPA B ‚Äì AUDITORIA DOS REQUISITOS EXISTENTES
---------------------------------------------
1. Para CADA requisito encontrado em TUDO PARA O GPT.txt e PATCH-ORACULO.md:
   - Verificar se foi implementado no c√≥digo.
   - Verificar se a implementa√ß√£o √© coerente com:
     - Seguran√ßa (RLS, env vars, sem vazamento de chave)
     - UX m√≠nima
     - Fluxos descritos nos docs

2. Classificar cada requisito como:
   - IMPLEMENTADO
   - IMPLEMENTADO PARCIAL
   - N√ÉO IMPLEMENTADO

3. Para requisitos "IMPLEMENTADO PARCIAL" ou "N√ÉO IMPLEMENTADO":
   - Implementar AGORA, dentro do escopo do projeto atual.
   - Se n√£o for poss√≠vel (depend√™ncia externa, limite de tempo, etc.), registrar como D√çVIDA T√âCNICA na L√ÇMPADA e no ROADMAP, explicando o motivo.

ETAPA C ‚Äì MATRIZ GLOBAL DE IAs (IA MATRIX)
------------------------------------------
Se ainda n√£o existir corretamente, implementar os seguintes elementos (ou revisar se j√° existem):

1. Tabelas em database/ (via migrations):
   - ai_providers
     - id, key (ex: "openai", "together", "claude", "grok"), nome_exibicao, status, custo_estimado, created_at, updated_at.
   - ai_menus
     - id, menu_key (ex: "chat", "diario", "teste_clareza", "oraculo_v2"), descricao.
   - ai_menu_providers
     - id, menu_id, provider_id, modo (ex: "principal", "fallback", "colaborativo"), peso, ativo.
   - ai_plan_overrides
     - id, plan_key (ex: "free", "pro", "white_label"), menu_key, provider_id, override_modo, override_peso, limite_diario, limite_mensal.
   - ai_usage_logs
     - id, user_id, menu_key, provider_key, tokens_in, tokens_out, custo_estimado, created_at.

2. Camada de c√≥digo em lib/ai-router.ts (ou similar):
   - Fun√ß√£o para decidir qual IA usar por:
     - menu_key
     - plano da usu√°ria
     - promo√ß√µes / overrides
   - Suporte a:
     - modo colaborativo (v√°rias IAs)
     - fallback
     - limites por plano

3. Painel ADMIN para gerenciar essa matriz:
   - P√°gina em /admin/ia-matrix ou integra√ß√£o em /admin/configurar-ias.
   - Listagem de menus (chat, di√°rio, teste de clareza, or√°culo, etc.).
   - Para cada menu, listar quais IAs podem ser usadas e em que modo.
   - Permitir ativar/desativar providers para cada menu.
   - Permitir overrides por plano (free, pro, promo√ß√µes, etc.).

4. Garantir que:
   - O admin consegue ver CLARAMENTE, por menu, quais IAs est√£o ativas.
   - O admin consegue mudar isso sem precisar fazer deploy de c√≥digo.
   - Logs de uso de IA s√£o gravados em ai_usage_logs.

ETAPA D ‚Äì MODO SIMULA√á√ÉO / IMPERSONATION
----------------------------------------
1. Implementar (ou revisar se j√° existe) um modo de SIMULA√á√ÉO no admin que permita:
   - Admin entrar como "modo usu√°ria" (perfil usu√°ria normal).
   - Admin entrar como "modo profissional" (perfil profissional).
   - Admin entrar como "modo whitelabel partner".
   - Admin entrar como "modo gerador de SaaS" (quando existir UI dedicada).

2. Regras:
   - Somente ADMIN pode entrar em modo simula√ß√£o.
   - Registrar em log (ex.: admin_impersonation_logs):
     - admin_id, user_simulado_id, perfil, data/hora, motivo (campo texto opcional).

3. O modo simula√ß√£o deve ser √∫til para:
   - Ver exatamente o que o cliente est√° vendo.
   - Reproduzir bugs relatados.
   - Testar planos, promo√ß√µes e overrides de IA.

ETAPA E ‚Äì HELP / MANUAL POR MENU
--------------------------------
1. Criar tabela admin_menu_help (se ainda n√£o existir):
   - id, menu_key, publico_alvo (admin, usuaria, profissional, whitelabel, gerador), titulo, conteudo_md, updated_at.

2. Para CADA menu importante do admin (planos, promo√ß√µes, or√°culo, IA, curadoria, beta, etc.):
   - Criar um texto em linguagem leiga explicando:
     - O que √© esse menu.
     - O que ele faz.
     - Para que serve.
     - Passo a passo b√°sico de uso.
     - Riscos/cautelas principais.

3. Integrar UI:
   - Em cada p√°gina do admin, adicionar um bot√£o/√≠cone de "?" (help).
   - Ao clicar, abrir um modal com o texto do help para aquele menu_key.

4. Replicar a l√≥gica (quando fizer sentido) para:
   - Painel whitelabel.
   - Painel gerador de SaaS.
   - Painel profissional.
   - Painel usu√°ria (help de funcionalidades complexas).

ETAPA F ‚Äì ORGANIZA√á√ÉO DO MENU ADMINISTRATIVO
--------------------------------------------
1. Organizar o menu do admin em grupos por prioridade, por exemplo:
   - FUNDAMENTAL: planos, usu√°rios, billing, IA, or√°culo, seguran√ßa.
   - PRODUTO: di√°rio, teste de clareza, relat√≥rios, estat√≠sticas.
   - CONTE√öDO: curadoria, biblioteca, blog, campanhas.
   - EXPERIMENTAL: beta, easter eggs, ab-testing.
   - SISTEMA: frontpage, config, terms, LGPD, health.

2. Se existir um arquivo central de configura√ß√£o do menu (ex.: adminMenuConfig.ts ou vindo do banco):
   - Reorganizar a estrutura l√°.
   - Garantir que o front monta o menu baseado nessa fonte √∫nica.

3. Atualizar TUDO PARA O GPT.txt e ATLAS com a nova organiza√ß√£o (incluindo lista dos menus e grupos).

ETAPA G ‚Äì SINCRONIZA√á√ÉO COM GERADOR DE SAAS
-------------------------------------------
1. Registrar em docs (ex.: GERADOR-SAAS.md ou dentro do ATLAS) que:
   - Tudo que for core do admin (IA matrix, help por menu, simula√ß√£o, etc.) faz parte do "CORE COMPARTILHADO".
   - O GERADOR DE SAAS pode clonar esse core para criar novos produtos.

2. No c√≥digo, separar o que for "CORE REUTILIZ√ÅVEL" em m√≥dulos/arquivos que possam ser reaproveitados.
   - Ex.: lib/ai-router.ts, lib/logger.ts, lib/rate-limit.ts, componentes de help, etc.

3. N√£o √© necess√°rio implementar o gerador inteiro agora, mas deixar expl√≠cito:
   - Quais partes do c√≥digo s√£o pensadas para serem reaproveitadas.

ETAPA H ‚Äì RESUMO FINAL PARA O USU√ÅRIO (CHATGPT)
-----------------------------------------------
Ao terminar TODAS as etapas acima, gerar um RESUMO FINAL neste formato:

1) RESUMO GERAL
   - Descrever em 5‚Äì10 bullets o que foi auditado e implementado.

2) TABELA DE AUDITORIA (ALTA VIS√ÉO)
   - Para cada grupo de requisitos (BLOCOS 1‚Äì20, 21‚Äì25, PATCH-ORACULO, IA MATRIX, SIMULA√á√ÉO, HELP, MENU ADMIN):
     - Status: IMPLEMENTADO / PARCIAL / N√ÉO IMPLEMENTADO
     - Observa√ß√µes curtas.

3) D√çVIDAS T√âCNICAS
   - Lista de d√≠vidas t√©cnicas com ID da L√ÇMPADA.

4) MELHORIAS IDENTIFICADAS
   - Lista de melhorias futuras, sem usar a palavra "opcional".

5) PR√ìXIMA A√á√ÉO SUGERIDA
   - Lista em bullets (sem "ou") das pr√≥ximas a√ß√µes concretas para o ChatGPT orientar o usu√°rio.

IMPORTANTE
----------
- Se em alguma parte voc√™ perceber que N√ÉO conseguiu implementar algo, seja expl√≠cito.
- N√£o finja que fez.
- Atualize sempre TUDO PARA O GPT.txt, ATLAS, ROADMAP, TESTES, L√ÇMPADA quando fizer mudan√ßas relevantes.

================================================================================
PATCH 1: CORRE√á√ÉO DO TIPO JournalEntryType NA TIMELINE
================================================================================

O erro indica que o tipo JournalEntryType na timeline n√£o est√° reconhecendo `'safety_plan'`. 

Problema encontrado: A timeline tem uma defini√ß√£o local do tipo `entry_type` na linha 82 que n√£o inclui `'safety_plan'`.

Solu√ß√£o aplicada: Atualizar a defini√ß√£o local do tipo na timeline para incluir `'safety_plan'`.

Arquivo alterado: app/diario/timeline/page.tsx (linha 82)

Build passou com sucesso ap√≥s a corre√ß√£o.

================================================================================
PATCH 2: BLOCO 21‚Äì25 ‚Äì P√ìS-MVP (COMPLETO)
================================================================================

**ETAPA 21 ‚Äì Billing S√≥lido & Add-ons (Stripe + user_addons)**
- Tabela `user_addons` + RLS
- Webhook Stripe para add-ons
- APIs `/api/addons` e `/api/addons/consume`
- `ENV-VARIABLES.md`
- Documenta√ß√£o atualizada (TUDO, ATLAS, ROADMAP, TESTES, L√ÇMPADA)
- Commit: `fe61cb1`

**ETAPA 22 ‚Äì Or√°culo V2 Integrado (API + Logs + Bot√£o + Manuais)**
- Rota `/api/oraculo-v2`
- Tabela `oraculo_logs` + migration
- `OraculoButton.tsx` em `/admin` e `/admin/oraculo`
- `docs/ORACULO-V2-PROMPT.md`
- Manuais ADMIN/DEV atualizados
- Commit: `0718c7c`

**ETAPA 23 ‚Äì Seguran√ßa T√©cnica & Observabilidade**
- `lib/rate-limit.ts`
- `lib/logger.ts`
- `/api/health`
- Rate limit ligado no Or√°culo V2 + rotas sens√≠veis
- Commit: `31d6a2b`

**ETAPA 24 ‚Äì Manuais & Links Internos**
- 5 manuais atualizados (USU√ÅRIA, PROFISSIONAL, ADMIN, DEV, WHITELABEL)
- Links internos + se√ß√µes novas
- Commit: `52e0458`

**ETAPA 25 ‚Äì QA T√©cnico + Checklist P√≥s-MVP**
- `CHECKLIST-POS-MVP.md`
- L√ÇMPADA e ROADMAP marcando d√≠vidas t√©cnicas e "feito / n√£o feito"
- Commit: `9275f78`

================================================================================
PATCH 3: OR√ÅCULO ‚Äì CORRE√á√ÉO CONCEITUAL
================================================================================

PATCH OR√ÅCULO ‚Äì CORRE√á√ÉO CONCEITUAL (PRIORIDADE M√ÅXIMA)

Este PATCH tem prioridade sobre qualquer texto antigo que diga o contr√°rio.
Ver documento completo: docs/PATCH-ORACULO.md

BLOCO 21-25 (ATUAL):
- OR√ÅCULO V1 = painel /admin/oraculo ‚Üí s√≥ ADMIN (j√° existe)
- OR√ÅCULO V2 = IA de suporte ‚Üí NESTE BLOCO √© apenas para ADMIN
- Qualquer men√ß√£o a Or√°culo V2 para usu√°ria/profissional/dev/whitelabel = FUTURO

BLOCO 26-30 (FUTURO EXPL√çCITO):
- OR√ÅCULO V2 MULTIPERFIL para TODOS os perfis: usu√°ria, profissional, admin, dev, whitelabel
- ORACULO_V2_CORE como m√≥dulo compartilhado
- Acopl√°vel a todos os SaaS gerados pelo GERADOR DE SAAS

REGRA PARA WINDSURF/CHATGPT:
Se texto antigo disser "Or√°culo para usu√°ria/profissional AGORA"
‚Üí ENTENDER COMO: "FUTURO BLOCO 26-30, N√ÉO IMPLEMENTADO EM 21-25"

================================================================================
PATCH 4: REGRAS DE COMUNICA√á√ÉO WINDSURF ‚Üî CHATGPT
================================================================================

Arquivo: docs/REGRAS-COMUNICACAO-IA.md

Regras principais:
1. Sugest√µes, ideias e opini√µes: sempre aparecem antes da execu√ß√£o.
2. "Melhorias opcionais" vira "MELHORIAS IDENTIFICADAS" (nunca usar "opcional").
3. Proibido usar "ou" dentro de "Pr√≥xima a√ß√£o sugerida": sempre bullets separados.
4. Windsurf escreve resumos em formato padr√£o para colar no ChatGPT.

================================================================================
PATCH 5: ORGANIZA√á√ÉO DOS BLOCOS 10‚Äì40
================================================================================

### BLOCO 21‚Äì25 (J√Å FECHADO)
- ETAPA 21 ‚Äì Billing S√≥lido & Add-ons
- ETAPA 22 ‚Äì Or√°culo V2 Integrado
- ETAPA 23 ‚Äì Seguran√ßa T√©cnica & Observabilidade
- ETAPA 24 ‚Äì Manuais & Links Internos
- ETAPA 25 ‚Äì QA T√©cnico + Checklist P√≥s-MVP

### BLOCO 26‚Äì30 ‚Äì OR√ÅCULO + GERADOR DE SAAS (N√öCLEO)
- 26 ‚Äì Or√°culo V2 multiperfil (exposi√ß√£o controlada)
- 27 ‚Äì ORACULO_V2_CORE + Gerador de SaaS
- 28 ‚Äì Limites e billing do Or√°culo
- 29 ‚Äì Logging avan√ßado do Or√°culo
- 30 ‚Äì Documenta√ß√£o espec√≠fica Or√°culo + Gerador

### BLOCO 31‚Äì35 ‚Äì CONTROLE DE IAs + MENUS + DASHBOARDS + AVATARES
- 31 ‚Äì Painel central de IAs (Admin MASTER)
- 32 ‚Äì Matriz IA √ó Menu √ó Plano √ó Perfil
- 33 ‚Äì Avatares / Personas de IA
- 34 ‚Äì Organizar Menus do Admin + HELP por menu
- 35 ‚Äì Modo simula√ß√£o (impersona√ß√£o segura)

### BLOCO 36‚Äì40 ‚Äì GERADOR DE SAAS + ADM EXTERNO + MULTI-INSTANCE
- 36 ‚Äì Gerador de SaaS: M√£e com tema
- 37 ‚Äì Gerador de SaaS: "Em branco" (sem tema)
- 38 ‚Äì Admin externo √∫nico (hub)
- 39 ‚Äì Gest√£o de planos avan√ßados / coortes
- 40 ‚Äì Documenta√ß√£o de clonagem e independ√™ncia

================================================================================
PATCH 6: GERENCIAMENTO DE IAs POR MENU / PLANO / PERFIL
================================================================================

Requisitos:
- Ver TODAS as IAs cadastradas (OpenAI, Claude, Together, Grok, etc.)
- Conseguir ligar/desligar IA:
  - Por MENU (Chat, Di√°rio, Teste de Clareza, Or√°culo, Curadoria, etc.)
  - Por PERFIL (usu√°ria, profissional, admin, whitelabel, gerador de SaaS)
  - Por PLANO (Free, Pro, Defesa, Promo Black Friday, grupo especial, etc.)
- Ter:
  - Um PAINEL GERAL de carga/uso das IAs
  - Controle tamb√©m replicado para White label e Gerador de SaaS

================================================================================
PATCH 7: MENU ADMIN + HELP POR MENU + ORGANIZA√á√ÉO
================================================================================

Requisitos:
- Reorganizar o menu admin por prioridade
- Unificar / juntar items redundantes
- Incluir HELP em cada menu explicando para leigo:
  - O que √© esse menu?
  - Para que serve?
  - Como usar passo a passo?
  - Qual o impacto no SaaS / usu√°ria / IA / custos?
- Replicar l√≥gica de help para:
  - Admin principal
  - Painel do parceiro whitelabel
  - Painel do gerador de SaaS (admin dele)
  - Painel profissional (vers√£o reduzida)

================================================================================
PATCH 8: AVATARES / PERSONAS PARA AS IAs
================================================================================

Requisitos:
- Usu√°rio NUNCA ver "OpenAI / Claude / Together / Grok" como nomes crus
- Em vez disso, cada IA ou combina√ß√£o de IA tem:
  - Nome de persona
  - Avatar
  - Descri√ß√£o amig√°vel ("Conselheira calma", "Analista de risco", etc.)
- Transpar√™ncia: Usu√°ria sabe que h√° IA, mas n√£o sabe a marca
- Aplicar em: Radar, Gerador de SaaS, White label

================================================================================
PATCH 9: MODO SIMULA√á√ÉO DE USU√ÅRIO / PROFISSIONAL / WHITE LABEL
================================================================================

Requisitos:
- No admin central:
  - "Entrar como usu√°ria X" (modo simula√ß√£o)
  - "Entrar como profissional Y"
  - "Entrar como dono do white-label Z"
- Uso:
  - Para suporte ("n√£o est√° funcionando aqui, v√™ pra mim")
  - Para QA manual
  - Para confer√™ncia de planos, menus, permiss√µes, IAs ativas
- Requisitos:
  - Tudo rastreado (log: quem simulou, quando, qual perfil)
  - Permiss√£o do usu√°rio profissional/cliente quando necess√°rio

================================================================================
MIGRATION SQL: ETAPA 7 ‚Äì PLANO DE SEGURAN√áA E ALERTAS DE RISCO
================================================================================

-- Verificar se os tipos existem antes de criar
DO $$ BEGIN
  CREATE TYPE safety_item_status AS ENUM ('PENDING', 'IN_PROGRESS', 'COMPLETED', 'NOT_APPLICABLE');
EXCEPTION
  WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
  CREATE TYPE risk_level AS ENUM ('LOW', 'MEDIUM', 'HIGH', 'CRITICAL');
EXCEPTION
  WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
  CREATE TYPE risk_category AS ENUM ('PHYSICAL_VIOLENCE', 'THREATS', 'ISOLATION', 'FINANCIAL_CONTROL', 'EMOTIONAL_ABUSE', 'STALKING', 'OTHER');
EXCEPTION
  WHEN duplicate_object THEN null;
END $$;

-- Tabela: safety_plans
CREATE TABLE IF NOT EXISTS public.safety_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users (id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  emergency_contacts JSONB DEFAULT '[]',
  important_documents JSONB DEFAULT '[]',
  emergency_bag_items JSONB DEFAULT '[]',
  safe_place JSONB,
  digital_security JSONB DEFAULT '{}',
  overall_status TEXT DEFAULT 'NOT_STARTED',
  last_reviewed_at TIMESTAMPTZ,
  notes TEXT
);

-- Tabela: risk_alerts
CREATE TABLE IF NOT EXISTS public.risk_alerts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users (id) ON DELETE CASCADE,
  source TEXT NOT NULL,
  source_id UUID,
  level risk_level NOT NULL,
  category risk_category NOT NULL,
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  recommendation TEXT,
  is_read BOOLEAN DEFAULT FALSE,
  is_dismissed BOOLEAN DEFAULT FALSE,
  dismissed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- RLS
ALTER TABLE public.safety_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.risk_alerts ENABLE ROW LEVEL SECURITY;

-- Pol√≠ticas RLS para safety_plans
DROP POLICY IF EXISTS "safety_plans_select_own" ON public.safety_plans;
DROP POLICY IF EXISTS "safety_plans_insert_own" ON public.safety_plans;
DROP POLICY IF EXISTS "safety_plans_update_own" ON public.safety_plans;

CREATE POLICY "safety_plans_select_own" ON public.safety_plans FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "safety_plans_insert_own" ON public.safety_plans FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "safety_plans_update_own" ON public.safety_plans FOR UPDATE USING (auth.uid() = user_id);

-- Pol√≠ticas RLS para risk_alerts
DROP POLICY IF EXISTS "risk_alerts_select_own" ON public.risk_alerts;
DROP POLICY IF EXISTS "risk_alerts_insert_own" ON public.risk_alerts;
DROP POLICY IF EXISTS "risk_alerts_update_own" ON public.risk_alerts;

CREATE POLICY "risk_alerts_select_own" ON public.risk_alerts FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "risk_alerts_insert_own" ON public.risk_alerts FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "risk_alerts_update_own" ON public.risk_alerts FOR UPDATE USING (auth.uid() = user_id);

-- √çndices
CREATE INDEX IF NOT EXISTS idx_safety_plans_user_id ON public.safety_plans(user_id);
CREATE INDEX IF NOT EXISTS idx_risk_alerts_user_id ON public.risk_alerts(user_id);
CREATE INDEX IF NOT EXISTS idx_risk_alerts_level ON public.risk_alerts(level);
CREATE INDEX IF NOT EXISTS idx_risk_alerts_created_at ON public.risk_alerts(created_at DESC);

================================================================================
INSTRU√á√ÉO FINAL PARA O WINDSURF
================================================================================

Voc√™ (Windsurf) recebeu este arquivo contendo TODOS os PROMPTS e PATCHES deste chat.

1) LEITURA E MARCA√á√ÉO
   ‚Äì Leia CADA bloco de prompt/patch, um por um, sem pular.
   ‚Äì Para cada bloco, responda internamente:
     ‚Ä¢ "J√° implementei 100%?"
     ‚Ä¢ "Implementei parcialmente?"
     ‚Ä¢ "Ainda n√£o implementei nada?"

2) A√á√ÉO
   ‚Äì Se j√° estiver 100% implementado no c√≥digo atual: apenas marque como FEITO.
   ‚Äì Se estiver parcialmente implementado: 
     ‚Ä¢ Conclua o que falta agora.
     ‚Ä¢ Atualize docs (TUDO, ATLAS, ROADMAP, TESTES, L√ÇMPADA).
   ‚Äì Se n√£o estiver implementado: 
     ‚Ä¢ Implemente agora (front, back, banco, o que for necess√°rio).
     ‚Ä¢ Atualize docs e fa√ßa commit.

3) SA√çDA ESPERADA PARA O EDUARDO
   ‚Äì Para cada bloco de prompt/patch:
     ‚Ä¢ Indicar: FEITO / PARCIAL / PENDENTE ‚Üí DEPOIS IMPLEMENTADO.
     ‚Ä¢ Listar arquivos criados/alterados.
     ‚Ä¢ Resumir o que foi implementado.
     ‚Ä¢ Apontar qualquer d√≠vida t√©cnica ou limita√ß√£o.

4) REGRA CRUCIAL
   ‚Äì Voc√™ N√ÉO pode dizer que fez o que n√£o fez.
   ‚Äì Se n√£o implementou, diga claramente.
   ‚Äì Eduardo vai auditar isso manualmente depois, conferindo no Git.

================================================================================
FIM DO ARQUIVO DE AUDITORIA
================================================================================
